<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <record id="view_sale_order_giftcard_list" model="ir.ui.view">
      <field name="name">sale.order.giftcard.list</field>
      <field name="model">sale.order</field>
      <field name="priority">1</field>
      <field name="arch" type="xml">
        <list string="Órdenes Giftcards">
          <field name="name"/>
          <field name="date_order"/>
          <field name="partner_id"/>
          <field name="franchise_id"/>
          <field name="gift_template_id"/>
          <field name="amount_total" sum="Total"/>
          <field name="invoice_status"
                 widget="badge"
                 decoration-info="invoice_status == 'to invoice'"
                 decoration-success="invoice_status == 'invoiced'"/>
        </list>
      </field>
    </record>

    <record id="view_sale_order_giftcard_form" model="ir.ui.view">
      <field name="name">sale.order.giftcard.form</field>
      <field name="model">sale.order</field>
      <field name="priority">40</field>
      <field name="arch" type="xml">
        <form string="Orden Giftcard">

          <header>
            <field name="state" widget="statusbar" statusbar_visible="draft,sent,sale,cancel"/>

            <button name="action_confirm" string="Confirmar" type="object" class="btn-primary"
                    invisible="state != 'draft'"/>
            <button name="action_cancel" string="Cancelar" type="object" class="btn-default"
                    invisible="state != 'draft'"/>

            <button name="action_create_gift_invoice" string="Crear factura" type="object" class="btn-primary"
                    invisible="state != 'sale' or invoice_status != 'to invoice'"/>
            <button name="action_cancel" string="Cancelar" type="object" class="btn-default"
                    invisible="state != 'sale'"/>
          </header>

          <sheet>
            <group>
              <field name="is_giftcard" invisible="1"/>
              <field name="allowed_franchise_ids" invisible="1"/>
              <field name="allowed_gift_template_ids" invisible="1"/>
              
              <field name="partner_id" widget="res_partner_many2one" context="{'res_partner_search_mode': 'customer'}"/>
              
              <field name="franchise_id"
                     invisible="not is_giftcard"
                     required="is_giftcard"
                     options="{'no_create': True, 'no_open': True}"
                     domain="[('id', 'in', allowed_franchise_ids)]"/>

              <field name="gift_template_id" 
                     invisible="not is_giftcard"
                     required="is_giftcard"
                     options="{'no_create': True, 'no_open': True}"
                     domain="[('id', 'in', allowed_gift_template_ids)]"
                     readonly="not franchise_id"/>
            </group>

            <group string="Líneas de Giftcard">
              <field name="order_line" widget="one2many_list">
                <list editable="bottom" create="0">
                  <field name="product_id" readonly="1" force_save="1"/>
                  <field name="name" string="Descripción / Evento" readonly="1" force_save="1"/>
                  <field name="rate_template_id" column_invisible="True" force_save="1"/>
                  <field name="product_uom_qty"/>
                  <field name="price_unit" readonly="1" force_save="1"/>
                  <field name="tax_id" widget="many2many_tags" readonly="1" force_save="1"/>
                  <field name="price_total" readonly="1"/>
                </list>
              </field>
            </group>

            <group string="Totales" class="oe_subtotal_footer oe_right">
              <field name="amount_untaxed" readonly="1" widget="monetary"/>
              <field name="amount_tax" readonly="1" widget="monetary"/>
              <field name="amount_total" readonly="1" class="oe_subtotal_footer_separator" widget="monetary"/>
            </group>
          </sheet>
        </form>
      </field>
    </record>

    <record id="action_sale_order_giftcards" model="ir.actions.act_window">
      <field name="name">Órdenes Giftcards</field>
      <field name="res_model">sale.order</field>
      <field name="view_mode">list,form</field>
      <field name="domain">[('is_giftcard','=',True)]</field>
      <field name="context">{'default_is_giftcard': True}</field>
    </record>

    <record id="action_gift_order_view_list" model="ir.actions.act_window.view">
        <field name="sequence" eval="1"/>
        <field name="view_mode">list</field>
        <field name="view_id" ref="view_sale_order_giftcard_list"/>
        <field name="act_window_id" ref="action_sale_order_giftcards"/>
    </record>

    <record id="action_gift_order_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_sale_order_giftcard_form"/>
        <field name="act_window_id" ref="action_sale_order_giftcards"/>
    </record>

    <menuitem id="menu_sale_order_giftcards" name="Órdenes Giftcards" parent="sale.sale_order_menu" action="action_sale_order_giftcards" sequence="25"/>

    <record id="sale.action_orders" model="ir.actions.act_window">
      <field name="domain">[('is_giftcard','=',False)]</field>
    </record>

    <record id="sale.action_quotations_with_onboarding" model="ir.actions.act_window">
      <field name="domain">[('is_giftcard','=',False)]</field>
    </record>

  </data>
</odoo>